<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jellyfin Enhanced</title>
</head>
<body>
<div class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-checkbox,emby-select" data-role="page" id="JellyfinEnhancedPage" style="color: #eee;">
    <div data-role="content">
        <div class="content-primary">
            <div class="verticalSection">
                <div class="sectionTitleContainer">
                     <h2 class="sectionTitle">Jellyfin Enhanced</h2>
                        <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;" target="_blank" href="https://github.com/n00bcodr/Jellyfin-Enhanced">
                            <i class="md-icon button-icon button-icon-left secondaryText"></i>
                            <span>Help</span>
                        </a>
                </div>
            </div>
            <hr>

            <div style="margin-bottom: 1em;">
                <button class="jellyfin-tab-button active" data-tab="enhanced" style="background: none; border: none; color: var(--primary-accent-color, #fff); cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid var(--primary-accent-color, #fff);"><h3>Enhanced Settings</h3></button>
                <button class="jellyfin-tab-button" data-tab="elsewhere" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent;"><h3>Elsewhere Settings</h3></button>
                <button class="jellyfin-tab-button" data-tab="jellyseerr" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent;"><h3>Jellyseerr Settings</h3></button>
                <button class="jellyfin-tab-button" data-tab="arr-links" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent;"><h3>*arr Links</h3></button>
            </div>
            <form id="JellyfinEnhancedForm">
                <div id="enhanced" class="jellyfin-tab-content active" style="display: block; font-family: inherit;">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Default User Settings</h3></legend>
                        <div class="configSection">
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">‚èØÔ∏è Playback Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoPauseEnabled" is="emby-checkbox" type="checkbox"/><span>Auto-pause on tab switch</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoResumeEnabled" is="emby-checkbox" type="checkbox"/><span>Auto-resume on tab switch</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoPipEnabled" is="emby-checkbox" type="checkbox"/><span>Auto Picture-in-Picture on tab switch</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label style="line-height: 1.2em; align-self: flex-start;"><input id="pauseScreenEnabled" is="emby-checkbox" type="checkbox"/><span>Enable Custom Pause Screen<div>This feature is a modified version of the original script by <a class="sectionTitle" target="_blank" href="https://github.com/BobHasNoSoul/Jellyfin-PauseScreen">BobHasNoSoul</a></div></span></label></div>
                                </div>
                            </details>
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">‚Ü™Ô∏è Auto-Skip Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoSkipIntro" is="emby-checkbox" type="checkbox"/><span>Auto-skip Intro</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="autoSkipOutro" is="emby-checkbox" type="checkbox"/><span>Auto-skip Outro</span></label></div>
                                </div>
                            </details>
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">üé≤ Random Button Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomButtonEnabled" is="emby-checkbox" type="checkbox"/><span>Enable Random Button</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomUnwatchedOnly" is="emby-checkbox" type="checkbox"/><span>Show unwatched only in random selection</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomIncludeMovies" is="emby-checkbox" type="checkbox"/><span>Include movies in random selection</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="randomIncludeShows" is="emby-checkbox" type="checkbox"/><span>Include shows in random selection</span></label></div>
                                </div>
                            </details>
                            <details style="margin-bottom: 1em; background-color: rgba(255,255,255,0.05); padding: 1em; border-radius: 5px;">
                                <summary style="cursor: pointer; font-weight: bold;">üñ•Ô∏è UI Settings</summary>
                                <div style="padding-top: 1em;">
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="showFileSizes" is="emby-checkbox" type="checkbox"/><span>Show file sizes</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="showAudioLanguages" is="emby-checkbox" type="checkbox"/><span>Show available audio languages on item detail page</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label><input id="removeContinueWatchingEnabled" is="emby-checkbox" type="checkbox"/><span>Enable "Remove from Continue Watching"</span></label></div>
                                    <div class="checkboxContainer" style="margin-bottom: 0.5em;"><label style="line-height: 1.2em; align-self: flex-start;"><input id="qualityTagsEnabled" is="emby-checkbox" type="checkbox"/><span>Enable Quality Tags<div>This feature is a slightly modified version of the original script by <a class="sectionTitle" target="_blank" href="https://github.com/BobHasNoSoul/Jellyfin-Qualitytags/">BobHasNoSoul</a></div></span></label></div>
                                </div>
                            </details>
                            <div
                                style="background-color: rgba(255, 255, 255, 0.05); border-left: 4px solid #00a4dc; border-radius: 4px; padding: .5em 1em; margin: 2em 0 .5em 0; display: flex; align-items: center; gap: 1em;">
                                <i class="material-icons" style="color: #00a4dc; font-size: 18px;">info</i>
                                <div>
                                    Changes only take effect when all the existing settings are Reset.
                                </div>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Shortcut Overrides</h3></legend>
                        <div style="margin-bottom: 2em; padding-bottom: 1.5em; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <h4 class="sectionTitle" style="margin-top: 0;">Add Override</h4>
                            <div style="display: flex; gap: 1em; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <select is="emby-select" id="add-shortcut-select" label="Shortcut Action"></select>
                                </div>
                                <div style="flex: 1;">
                                    <input is="emby-input" id="add-shortcut-key" type="text" label="New Key"/>
                                </div>
                                <button is="emby-button" type="button" id="add-shortcut-btn" class="raised button-submit" style="top: 10px;">
                                    <span>Add</span>
                                </button>
                            </div>
                            <div id="shortcut-error-comment" style="display: none; color: #ffdddd; font-size: 0.9em; margin-top: 0.75em; background-color: rgba(220, 53, 69, 0.2); padding: 0.5em; border-radius: 4px; border-left: 3px solid #dc3545;"></div>
                            <p class="fieldDescription" style="margin-top: 1em;">
                                <b>Modifier Keys:</b> Use `Shift+`, `Ctrl+`, or `Alt+`. Examples: `Shift+A`, `Ctrl+S`.
                            </p>
                        </div>
                        <h4 class="sectionTitle" style="margin-top: 0;">Configured Overrides</h4>
                        <div id="shortcut-list-container" style="display: flex; flex-direction: column; margin-top: 1em;">
                            </div>
                    </fieldset>
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Timeout Settings</h3></legend>
                        <div class="configSection">
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="HelpPanelAutocloseDelay">Help Panel Autoclose Delay (in milliseconds)</label>
                                <input id="HelpPanelAutocloseDelay" is="emby-input" name="HelpPanelAutocloseDelay" type="number"/>
                                <div class="fieldDescription">How long the help panel stays open before auto-closing.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="ToastDuration">Toast Duration (in milliseconds)</label>
                                <input id="ToastDuration" is="emby-input" name="ToastDuration" type="number"/>
                                <div class="fieldDescription">How long toast notifications are displayed.</div>
                            </div>
                        </div>
                    </fieldset>
                    <div class="verticalSection">
                        <button id="clearLocalStorageBtn" class="raised button-cancel block emby-button" is="emby-button" type="button">
                            <span>Reset Settings for all users</span>
                        </button>
                    </div>
                </div>

                <div id="elsewhere" class="jellyfin-tab-content" style="display: none; font-family: inherit;">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Configuration</h3></legend>
                        <div class="configSection">
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="TMDB_API_KEY">TMDB API Key</label>
                                <input id="TMDB_API_KEY" is="emby-input" name="TMDB_API_KEY" type="text"/>
                                <div class="fieldDescription">Your API key from The Movie DB (TMDB). <a class="sectionTitle" target="_blank" href="https://www.themoviedb.org/settings/api">How to?</a></div>
                                <div class="fieldDescription">Leaving this blank will not load Jellyfin Elsewhere</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="DEFAULT_REGION">Default Region</label>
                                <input id="DEFAULT_REGION" is="emby-input" name="DEFAULT_REGION" type="text" placeholder="e.g., US"/>
                                <div class="fieldDescription">The default two-letter country code for streaming provider lookup. Empty defaults to US. <a class="sectionTitle" target="_blank" href="https://raw.githubusercontent.com/n00bcodr/Jellyfin-Elsewhere/refs/heads/main/resources/regions.txt">Full List</a></div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="DEFAULT_PROVIDERS">Default Providers</label>
                                <textarea style="display:block; height: 10vh !important;" class="emby-textarea emby-input" id="DEFAULT_PROVIDERS" name="DEFAULT_PROVIDERS" placeholder="e.g., Netflix,Hulu"></textarea>
                                <div class="fieldDescription">A list of default streaming providers to show. Leave blank to show all. <a class="sectionTitle" target="_blank" href="https://raw.githubusercontent.com/n00bcodr/Jellyfin-Elsewhere/refs/heads/main/resources/providers.txt">Full List</a></div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="IGNORE_PROVIDERS">Ignore Providers</label>
                                <textarea style="display:block; height: 10vh !important;" class="emby-textarea emby-input" id="IGNORE_PROVIDERS" name="IGNORE_PROVIDERS" placeholder="e.g., .*with Ads, Hulu"></textarea>
                                <div class="fieldDescription">A list of providers to ignore from the default region (supports regex).<a class="sectionTitle" target="_blank" href="https://raw.githubusercontent.com/n00bcodr/Jellyfin-Elsewhere/refs/heads/main/resources/providers.txt">Full List</a></div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div id="jellyseerr" class="jellyfin-tab-content" style="display: none; font-family: inherit;">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Configuration</h3></legend>
                        <div class="configSection">
                            <div class="checkboxContainer" style="margin-bottom: 0.5em !important;">
                                <label>
                                    <input id="jellyseerrEnabled" is="emby-checkbox" type="checkbox"/>
                                    <span>Show Jellyseerr Results in Search</span>
                                </label>
                            </div>
                            <div class="fieldDescription" style="margin-bottom: 2em;">Enhance Jellyfin search by showing results from Jellyseerr.<br>This allows users to discover and request missing movies and shows directly from Jellyfin.</div>
                            <div class="checkboxContainer" style="margin-bottom: 0.5em !important;">
                                <label>
                                    <input id="jellyseerrShowAdvanced" is="emby-checkbox" type="checkbox"/>
                                    <span>Show advanced request options</span>
                                </label>
                            </div>
                            <div class="fieldDescription" style="margin-bottom: 2em;">Enable this if you want users to be able to choose between Servers, Quality and Paths while requesting.</div>
                            <div class="inputContainer">
                                <label class="sectionTitle" style="margin-bottom: 5px;" for="jellyseerrUrls">Jellyseerr URL(s)</label>
                                <textarea style="display:block; height: 8vh !important;" class="emby-textarea emby-input" id="jellyseerrUrls" name="jellyseerrUrls" placeholder="http://192.168.1.10:5055&#10;https://jellyseerr.example.com"></textarea>
                                <div class="fieldDescription">Enter your Jellyseerr instance URLs, one per line. The script will use the first one that connects successfully.</div>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="JellyseerrApiKey">Jellyseerr API Key</label>
                                <div style="display: flex; align-items: center; gap: 1em; margin-left: -1em;">
                                    <input id="JellyseerrApiKey" is="emby-input" name="JellyseerrApiKey" type="text" style="flex-grow: 1;"/>
                                    <span id="jellyseerrStatusIndicator" class="material-icons" style="transition: color 0.3s ease;"></span>
                                    <button is="emby-button" type="button" id="testJellyseerrBtn" class="raised button-submit">
                                        <span>Test</span>
                                    </button>
                                </div>
                                <div class="fieldDescription">API key from Jellyseerr. (Settings > General Settings >  API Key)</div>
                            </div>
                            <div
                                style="background-color: rgba(255, 255, 255, 0.05); border-left: 4px solid #00a4dc; border-radius: 4px; padding: 1em 1.5em; margin: 1.5em 0; display: flex; align-items: center; gap: 1em;">
                                <i class="material-icons" style="color: #00a4dc; font-size: 18px;">info</i>
                                <div>
                                    "<b>Enable Jellyfin Sign-In</b>" must be enabled in Jellyseerr User Settings (/settings/users)<br><br>
                                    All users much be imported to Jellyseer as Jellyfin users for them to be able to request conetnt.
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div id="arr-links" class="jellyfin-tab-content" style="display: none; font-family: inherit;">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend class="sectionTitle"><h3>Configuration</h3></legend>
                        <div class="configSection">
                            <div class="checkboxContainer" style="margin-bottom: 0.5em !important;">
                                <label>
                                    <input id="arrLinksEnabled" is="emby-checkbox" type="checkbox"/>
                                    <span>Enable *arr Links</span>
                                </label>
                            </div>
                            <div class="fieldDescription" style="margin-bottom: 2em;">Show Sonarr, Radarr, and Bazarr links* of the items on item detail pages for quick access. Only for admins.<br> If no URL is added link is not shown.</div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="sonarrUrl">Sonarr URL</label>
                                <input id="sonarrUrl" is="emby-input" name="sonarrUrl" type="text" placeholder="e.g., http://192.168.100.100:8989"/>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="radarrUrl">Radarr URL</label>
                                <input id="radarrUrl" is="emby-input" name="radarrUrl" type="text" placeholder="e.g., http://192.168.100.100:7878"/>
                            </div>
                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="bazarrUrl">Bazarr URL</label>
                                <input id="bazarrUrl" is="emby-input" name="bazarrUrl" type="text" placeholder="e.g., http://192.168.100.100:6767"/>
                                <div class="fieldDescription">Note: This links to the main movies/series page as Bazarr does not support direct links.</div>
                            </div>
                            <div class="checkboxContainer" style="margin-top: 1em;">
                                <label>
                                    <input id="showArrLinksAsText" is="emby-checkbox" type="checkbox"/>
                                    <span>Show links as text instead of icons</span>
                                </label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div
                    style="background-color: rgba(255, 255, 255, 0.05); border-left: 4px solid #00a4dc; border-radius: 4px; padding: 1em 1.5em; margin: 1.5em 0; display: flex; align-items: center; gap: 1em;">
                    <i class="material-icons" style="color: #00a4dc; font-size: 24px;">info</i>
                    <div>
                        All changes require a page refresh to take effect. <br/>
                        If old settings persist, please force clear browser cache.
                    </div>
                </div>
                <div>
                    <button class="raised button-submit block emby-button" is="emby-button" type="submit">
                        <span>Save</span>
                    </button>
                </div>

            </form>
        </div>
    </div>
<script type="text/javascript">
        (() => {
            const pluginId = 'f69e946a-4b3c-4e9a-8f0a-8d7c1b2c4d9b';
            const page = document.querySelector('#JellyfinEnhancedPage');
            const form = document.querySelector('#JellyfinEnhancedForm');
            const clearLocalStorageBtn = document.querySelector('#clearLocalStorageBtn');

            const shortcutListContainer = document.getElementById('shortcut-list-container');
            const addShortcutSelect = document.getElementById('add-shortcut-select');
            const addShortcutKeyInput = document.getElementById('add-shortcut-key');
            const addShortcutBtn = document.getElementById('add-shortcut-btn');
            const shortcutErrorComment = document.getElementById('shortcut-error-comment');

            const testJellyseerrBtn = document.getElementById('testJellyseerrBtn');
            const jellyseerrStatusIndicator = document.getElementById('jellyseerrStatusIndicator');

            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin { to { transform: rotate(360deg); } }
                .status-check { animation: spin 1s linear infinite; }
                @keyframes shake {
                    10%, 90% { transform: translate3d(-1px, 0, 0); }
                    20%, 80% { transform: translate3d(2px, 0, 0); }
                    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
                    40%, 60% { transform: translate3d(4px, 0, 0); }
                }
                .shake {
                    animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
                }
            `;
            document.head.appendChild(style);

            let shortcutOverrides = [];

            const tabs = document.querySelectorAll('.jellyfin-tab-button');
            const tabContents = document.querySelectorAll('.jellyfin-tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.color = '#ccc';
                        t.style.borderBottom = '2px solid transparent';
                    });
                    tab.classList.add('active');
                    tab.style.color = 'var(--primary-accent-color, #fff)';
                    tab.style.borderBottom = '2px solid var(--primary-accent-color, #fff)';
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    const activeTab = document.getElementById(tab.dataset.tab)
                    activeTab.classList.add('active');
                    activeTab.style.display = 'block';
                });
            });

        const defaultShortcuts = [
            { Name: "OpenSearch", Key: "/", Label: "Open Search", Category: "Global" },
            { Name: "GoToHome", Key: "Shift+H", Label: "Go to Home", Category: "Global" },
            { Name: "GoToDashboard", Key: "D", Label: "Go to Dashboard", Category: "Global" },
            { Name: "QuickConnect", Key: "Q", Label: "Quick Connect", Category: "Global" },
            { Name: "PlayRandomItem", Key: "R", Label: "Play Random Item", Category: "Global" },
            { Name: "ClearAllBookmarks", Key: "Ctrl+Shift+B", Label: "Clear All Bookmarks", Category: "Global" },
            { Name: "CycleAspectRatio", Key: "A", Label: "Cycle Aspect Ratio", Category: "Player" },
            { Name: "ShowPlaybackInfo", Key: "I", Label: "Show Playback Info", Category: "Player" },
            { Name: "SubtitleMenu", Key: "S", Label: "Subtitle Menu", Category: "Player" },
            { Name: "CycleSubtitleTracks", Key: "C", Label: "Cycle Subtitle Tracks", Category: "Player" },
            { Name: "CycleAudioTracks", Key: "V", Label: "Cycle Audio Tracks", Category: "Player" },
            { Name: "IncreasePlaybackSpeed", Key: "+", Label: "Increase Playback Speed", Category: "Player" },
            { Name: "DecreasePlaybackSpeed", Key: "-", Label: "Decrease Playback Speed", Category: "Player" },
            { Name: "ResetPlaybackSpeed", Key: "R", Label: "Reset Playback Speed", Category: "Player" },
            { Name: "BookmarkCurrentTime", Key: "B", Label: "Bookmark Current Time", Category: "Player" },
            { Name: "GoToSavedBookmark", Key: "Shift+B", Label: "Go to Saved Bookmark", Category: "Player" }
        ];

        function renderOverrides() {
            shortcutListContainer.innerHTML = '';
            if (shortcutOverrides.length === 0) {
                shortcutListContainer.innerHTML = '<p class="fieldDescription" style="text-align: center;">No overrides configured. All shortcuts are using default values.</p>';
            }
            shortcutOverrides.forEach((shortcut, index) => {
                const row = document.createElement('div');
                row.className = 'inputContainer';
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '1em';

                const label = document.createElement('label');
                label.className = 'inputLabel';
                label.textContent = shortcut.Label;
                label.style.flex = '1';

                const input = document.createElement('input');
                input.setAttribute('is', 'emby-input');
                input.type = 'text';
                input.value = shortcut.Key;
                input.style.flex = '1';
                input.style.textAlign = 'center';
                input.addEventListener('input', (e) => {
                    let value = e.target.value;
                    // Automatically convert single lowercase letters to uppercase ***
                    if (value.match(/^[a-z]$/)) {
                        value = value.toUpperCase();
                        e.target.value = value;
                    }
                    shortcutOverrides[index].Key = value;
                });


                const buttonContainer = document.createElement('div');
                const removeBtn = document.createElement('button');
                removeBtn.setAttribute('is', 'emby-button');
                removeBtn.type = 'button';
                removeBtn.textContent = 'Remove';
                removeBtn.className = 'raised button-cancel';
                removeBtn.style.marginLeft = '1em';
                removeBtn.addEventListener('click', () => {
                    shortcutOverrides.splice(index, 1);
                    renderOverrides();
                    populateAddShortcutDropdown();
                });

                buttonContainer.appendChild(removeBtn);
                row.appendChild(label);
                row.appendChild(input);
                row.appendChild(buttonContainer);
                shortcutListContainer.appendChild(row);
            });
        }

        function populateAddShortcutDropdown() {
            addShortcutSelect.innerHTML = '';
            const overriddenNames = shortcutOverrides.map(s => s.Name);
            const availableShortcuts = defaultShortcuts.filter(s => !overriddenNames.includes(s.Name));

            availableShortcuts.forEach(shortcut => {
                const option = document.createElement('option');
                option.value = shortcut.Name;
                option.textContent = shortcut.Label;
                addShortcutSelect.appendChild(option);
            });
            addShortcutBtn.disabled = availableShortcuts.length === 0;
            addShortcutKeyInput.disabled = availableShortcuts.length === 0;
        }

        function showValidationError(elementToShake, message) {
            shortcutErrorComment.textContent = message;
            shortcutErrorComment.style.display = 'block';
            elementToShake.classList.add('shake');

            setTimeout(() => {
                elementToShake.classList.remove('shake');
                shortcutErrorComment.style.display = 'none';
            }, 8000);
        }

        addShortcutBtn.addEventListener('click', () => {
            const selectedName = addShortcutSelect.value;
            let newKey = addShortcutKeyInput.value.trim();

            // Automatically convert single lowercase letters to uppercase ***
            if (newKey.match(/^[a-z]$/)) {
                newKey = newKey.toUpperCase();
            }

            // Check 0: See if there is a key being added
            if (!selectedName || !newKey) {
                showValidationError(addShortcutBtn, 'Please enter a key to use as an override.');
                return;
            }

            // Check 1: See if the key is already used in another custom override.
            const overrideConflict = shortcutOverrides.find(s => s.Key.toLowerCase() === newKey.toLowerCase());

            if (overrideConflict) {
                const errorMessage = "The key '" + newKey + "' is already assigned to '" + overrideConflict.Label + "' as an override.";
                showValidationError(addShortcutKeyInput.parentElement, errorMessage);
                return;
            }

            // Check 2: See if the key is used by another default shortcut.
            const defaultConflict = defaultShortcuts.find(s => s.Key.toLowerCase() === newKey.toLowerCase() && s.Name !== selectedName);

            if (defaultConflict) {
                const errorMessage = "The key '" + newKey + "' is already used by '" + defaultConflict.Label + "'.";
                showValidationError(addShortcutKeyInput.parentElement, errorMessage);
                return;
            }

            const defaultConfig = defaultShortcuts.find(s => s.Name === selectedName);
            if (defaultConfig) {
                shortcutOverrides.push({ ...defaultConfig, Key: newKey });
                renderOverrides();
                populateAddShortcutDropdown();
                addShortcutKeyInput.value = '';
            }
        });

        async function testJellyseerrConnection() {
            const urls = (document.querySelector('#jellyseerrUrls').value || '').split('\n').map(u => u.trim()).filter(Boolean);
            const apiKey = (document.querySelector('#JellyseerrApiKey').value || '').trim();

            if (!urls.length || !apiKey) {
                Dashboard.alert({ title: 'Missing Information', message: 'Please provide at least one Jellyseerr URL and an API key to test the connection.' });
                return;
            }

            testJellyseerrBtn.disabled = true;
            jellyseerrStatusIndicator.textContent = 'sync';
            jellyseerrStatusIndicator.className = 'material-icons status-check';
            jellyseerrStatusIndicator.style.color = '#00a4dc';

            let validated = false;
            for (const url of urls) {
                try {
                    const validationUrl = ApiClient.getUrl(`/JellyfinEnhanced/jellyseerr/validate`, {
                        url: url,
                        apiKey: apiKey
                    });
                    console.debug("Attempting to validate with URL:", validationUrl);

                    const res = await ApiClient.ajax({ type: 'GET', url: validationUrl, dataType: 'json' });

                    if (res && res.ok) {
                        validated = true;
                        break;
                    }
                } catch (e) {
                    console.error(`Jellyseerr validation failed for ${url}:`, e);
                }
            }

            testJellyseerrBtn.disabled = false;
            jellyseerrStatusIndicator.classList.remove('status-check');

            if (validated) {
                jellyseerrStatusIndicator.textContent = 'check_circle';
                jellyseerrStatusIndicator.style.color = '#52b54b';
                Dashboard.alert({ title: 'Success', message: 'Successfully connected to Jellyseerr!' });
            } else {
                jellyseerrStatusIndicator.textContent = 'error';
                jellyseerrStatusIndicator.style.color = '#dc3545';
                Dashboard.alert({ title: 'Connection Failed', message: 'Could not validate the API key against any provided URL.<br><br>Please check the details.' });
            }
        }


        function loadConfig() {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(pluginId).then((config) => {
                const savedShortcuts = (config.Shortcuts && config.Shortcuts.length > 0) ? config.Shortcuts : defaultShortcuts;
                shortcutOverrides = savedShortcuts.filter(saved => {
                    const def = defaultShortcuts.find(d => d.Name === saved.Name);
                    return !def || saved.Key !== def.Key;
                });

                renderOverrides();
                populateAddShortcutDropdown();

                // Load all other settings
                document.querySelector('#ToastDuration').value = config.ToastDuration;
                document.querySelector('#HelpPanelAutocloseDelay').value = config.HelpPanelAutocloseDelay;
                document.querySelector('#TMDB_API_KEY').value = config.TMDB_API_KEY;
                document.querySelector('#DEFAULT_REGION').value = config.DEFAULT_REGION;
                document.querySelector('#DEFAULT_PROVIDERS').value = config.DEFAULT_PROVIDERS;
                document.querySelector('#IGNORE_PROVIDERS').value = config.IGNORE_PROVIDERS;
                document.querySelector('#autoPauseEnabled').checked = config.AutoPauseEnabled;
                document.querySelector('#autoResumeEnabled').checked = config.AutoResumeEnabled;
                document.querySelector('#autoPipEnabled').checked = config.AutoPipEnabled;
                document.querySelector('#autoSkipIntro').checked = config.AutoSkipIntro;
                document.querySelector('#autoSkipOutro').checked = config.AutoSkipOutro;
                document.querySelector('#randomButtonEnabled').checked = config.RandomButtonEnabled;
                document.querySelector('#randomIncludeMovies').checked = config.RandomIncludeMovies;
                document.querySelector('#randomIncludeShows').checked = config.RandomIncludeShows;
                document.querySelector('#randomUnwatchedOnly').checked = config.RandomUnwatchedOnly;
                document.querySelector('#showFileSizes').checked = config.ShowFileSizes;
                document.querySelector('#showAudioLanguages').checked = config.ShowAudioLanguages;
                document.querySelector('#removeContinueWatchingEnabled').checked = config.RemoveContinueWatchingEnabled;
                document.querySelector('#qualityTagsEnabled').checked = config.QualityTagsEnabled;
                document.querySelector('#pauseScreenEnabled').checked = config.PauseScreenEnabled;
                document.querySelector('#jellyseerrEnabled').checked = config.JellyseerrEnabled;
                document.querySelector('#jellyseerrShowAdvanced').checked = config.JellyseerrShowAdvanced;
                document.querySelector('#jellyseerrUrls').value = config.JellyseerrUrls;
                document.querySelector('#JellyseerrApiKey').value = config.JellyseerrApiKey;
                document.querySelector('#arrLinksEnabled').checked = config.ArrLinksEnabled;
                document.querySelector('#sonarrUrl').value = config.SonarrUrl;
                document.querySelector('#radarrUrl').value = config.RadarrUrl;
                document.querySelector('#bazarrUrl').value = config.BazarrUrl;
                document.querySelector('#showArrLinksAsText').checked = config.ShowArrLinksAsText;

                Dashboard.hideLoadingMsg();
            });
        }

        async function saveConfig(e) {
            e.preventDefault();
            Dashboard.showLoadingMsg();

            const config = await ApiClient.getPluginConfiguration(pluginId);
            const finalShortcuts = [...defaultShortcuts];
            shortcutOverrides.forEach(override => {
                const index = finalShortcuts.findIndex(s => s.Name === override.Name);
                if (index !== -1) finalShortcuts[index] = override;
            });
            config.Shortcuts = finalShortcuts;

            config.ToastDuration = parseInt(document.querySelector('#ToastDuration').value, 10);
            config.HelpPanelAutocloseDelay = parseInt(document.querySelector('#HelpPanelAutocloseDelay').value, 10);
            config.TMDB_API_KEY = document.querySelector('#TMDB_API_KEY').value;
            config.DEFAULT_REGION = document.querySelector('#DEFAULT_REGION').value;
            config.DEFAULT_PROVIDERS = document.querySelector('#DEFAULT_PROVIDERS').value;
            config.IGNORE_PROVIDERS = document.querySelector('#IGNORE_PROVIDERS').value;
            config.AutoPauseEnabled = document.querySelector('#autoPauseEnabled').checked;
            config.AutoResumeEnabled = document.querySelector('#autoResumeEnabled').checked;
            config.AutoPipEnabled = document.querySelector('#autoPipEnabled').checked;
            config.AutoSkipIntro = document.querySelector('#autoSkipIntro').checked;
            config.AutoSkipOutro = document.querySelector('#autoSkipOutro').checked;
            config.RandomButtonEnabled = document.querySelector('#randomButtonEnabled').checked;
            config.RandomIncludeMovies = document.querySelector('#randomIncludeMovies').checked;
            config.RandomIncludeShows = document.querySelector('#randomIncludeShows').checked;
            config.RandomUnwatchedOnly = document.querySelector('#randomUnwatchedOnly').checked;
            config.ShowFileSizes = document.querySelector('#showFileSizes').checked;
            config.ShowAudioLanguages = document.querySelector('#showAudioLanguages').checked;
            config.RemoveContinueWatchingEnabled = document.querySelector('#removeContinueWatchingEnabled').checked;
            config.QualityTagsEnabled = document.querySelector('#qualityTagsEnabled').checked;
            config.PauseScreenEnabled = document.querySelector('#pauseScreenEnabled').checked;
            config.JellyseerrEnabled = document.querySelector('#jellyseerrEnabled').checked;
            config.JellyseerrShowAdvanced = document.querySelector('#jellyseerrShowAdvanced').checked;
            config.JellyseerrUrls = (document.querySelector('#jellyseerrUrls').value || '').split('\n').map(u => u.trim()).filter(Boolean).join('\n');
            config.JellyseerrApiKey = (document.querySelector('#JellyseerrApiKey').value || '').trim();
            config.ArrLinksEnabled = document.querySelector('#arrLinksEnabled').checked;
            config.SonarrUrl = document.querySelector('#sonarrUrl').value;
            config.RadarrUrl = document.querySelector('#radarrUrl').value;
            config.BazarrUrl = document.querySelector('#bazarrUrl').value;
            config.ShowArrLinksAsText = document.querySelector('#showArrLinksAsText').checked;

            try {
                const result = await ApiClient.updatePluginConfiguration(pluginId, config);
                Dashboard.processPluginConfigurationUpdateResult(result);
            } catch {
                Dashboard.hideLoadingMsg();
            }
            return false;
        }

        function clearLocalStorage() {
            if (confirm("Are you sure?\n\nThis will reset Jellyfin Enhanced settings for all users to defaults on next load.")) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then((config) => {
                    config.ClearLocalStorageTimestamp = Date.now();
                    ApiClient.updatePluginConfiguration(pluginId, config).then((result) => {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    });
                });
            }
        }

        page.addEventListener('pageshow', loadConfig);
        form.addEventListener('submit', saveConfig);
        clearLocalStorageBtn.addEventListener('click', clearLocalStorage);
        testJellyseerrBtn.addEventListener('click', testJellyseerrConnection);
    })();
</script>
</div>
</body>
</html>